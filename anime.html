<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø£Ù†Ù…ÙŠ</title>

<style>
body { font-family: Arial, sans-serif; background:#121212; color:#fff; margin:0; padding:0; text-align:center; }
header { background:#ff3b3f; padding:20px; font-size:26px; font-weight:bold; }
button {
    margin:5px; padding:10px 15px; border-radius:5px;
    border:none; cursor:pointer; background:#ff3b3f; color:#fff;
    transition:0.3s;
}
button:hover { opacity:0.8; }

#episodeList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    justify-items: center;
    margin:20px auto;
    max-width: 900px;
}

#episodeList button { width:100%; }

.modal {
    display:none; position:fixed; z-index:1000;
    left:0; top:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
}
.modal-content {
    position:relative; background:#000; padding:10px; border-radius:10px;
    max-width:900px; width:90%;
}
.close-btn {
    position:absolute; top:5px; right:10px;
    background:#ff3b3f; border:none; color:#fff;
    font-size:18px; padding:5px 10px; cursor:pointer; border-radius:5px;
}
iframe { width:100%; height:500px; border:none; border-radius:10px; }

img.anime-img {
    width:95%; max-width:600px; border-radius:10px;
    margin-top:20px; box-shadow:0 0 20px #ff3b3f;
}
.anime-categories, .anime-type {
    margin:10px 0; font-size:15px; color:#ffcc00;
}
.view-counter {
    margin-top:5px; color:#ffcc00; font-size:14px;
}
</style>
</head>
<body>

<header>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø£Ù†Ù…ÙŠ</header>
<button onclick="goHome()">â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<div id="animeContainer">
    <p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…ÙŠ...</p>
</div>

<div id="videoModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">âœ–</button>
        <iframe id="videoFrame" src="" allowfullscreen></iframe>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
function goHome(){ window.location.href="index.html"; }

function getAnimeTitle(){
    const params = new URLSearchParams(window.location.search);
    return params.get('title');
}

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBYEyu6TxSv1qSLCRvr0YCdaVcewhxAmQY",
  authDomain: "appp-1234.firebaseapp.com",
  databaseURL: "https://appp-1234-default-rtdb.firebaseio.com",
  projectId: "appp-1234",
  storageBucket: "appp-1234.firebasestorage.app",
  messagingSenderId: "666495369108",
  appId: "1:666495369108:web:aabf062e066cea6c3b9981",
  measurementId: "G-ENJMS8EWNT"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const animesRef = database.ref('animes');

let foundKey = null;
let foundAnime = null;

animesRef.once('value', snapshot=>{
    const data = snapshot.val();
    if(!data) return;

    const title = getAnimeTitle();

    Object.keys(data).forEach(key=>{
        if(data[key].title === title){
            foundKey = key;
            foundAnime = data[key];
        }
    });

    if(foundAnime){
        showAnime(foundAnime);
        addView(foundKey);
    } else {
        document.getElementById("animeContainer").innerHTML = "<p>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù†Ù…ÙŠ</p>";
    }
});

function addView(animeKey){
    const ref = database.ref("animes/"+animeKey+"/views");
    ref.transaction(current => (current || 0) + 1);
}

function showAnime(anime){
    const container = document.getElementById("animeContainer");
    const categories = Array.isArray(anime.category) ? anime.category.join("ØŒ ") : (anime.category || "");
    const type = anime.type || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

    container.innerHTML = `
        <img src="${anime.image}" class="anime-img">
        <h2>${anime.title}</h2>
        <div class="anime-categories">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª: ${categories}</div>
        <div class="anime-type">Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ù…ÙŠ: ${type}</div>
        <div class="view-counter">ğŸ‘ ${(anime.views || 0) + 1} Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
        <h3>${anime.season || ""}</h3>
        <div id="episodeList"></div>
        <p>Ø§Ø®ØªØ± Ø­Ù„Ù‚Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</p>
    `;

    const episodeList = document.getElementById("episodeList");
    episodeList.innerHTML = "";

    if(Array.isArray(anime.episodes)){
        anime.episodes.forEach(ep=>{
            const btn = document.createElement("button");
            btn.textContent = ep.title;
            btn.onclick = ()=> openModal(ep.video);
            episodeList.appendChild(btn);
        });
    }
}

// ====== Adsterra + ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø© ======
function openModal(videoUrl){

    const adLink = "https://www.effectivegatecpm.com/g31pp6c9?key=08a82cb4c410cfb14ad1a25abef6221d";

    // Ø¹Ø¯Ù‘ Ø§Ù„Ø¶ØºØ·Ø§Øª Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø©
    let clickCount = sessionStorage.getItem("episodeClicks");
    if(!clickCount) clickCount = 0;

    clickCount = parseInt(clickCount) + 1;
    sessionStorage.setItem("episodeClicks", clickCount);

    // Ø§Ù„Ø¶ØºØ·Ø© 1 Ùˆ 2 â†’ Ø¥Ø¹Ù„Ø§Ù† ÙÙ‚Ø·
    if(clickCount === 1 || clickCount === 2){
        window.open(adLink, "_blank");
        return; 
    }

    // Ø§Ù„Ø¶ØºØ·Ø© 3 â†’ Ù†Ø´ØºÙ„ Ø§Ù„Ø­Ù„Ù‚Ø© Ùˆ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„ØµÙØ±
    if(clickCount >= 3){
        sessionStorage.setItem("episodeClicks", 0);
    }

    // ---- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø© ----
    let canEmbed = false;

    if(videoUrl.includes("youtube.com/watch")){
        const urlObj = new URL(videoUrl);
        const id = urlObj.searchParams.get("v");
        if(id){
            videoUrl = "https://www.youtube.com/embed/" + id;
            canEmbed = true;
        }
    }
    else if(videoUrl.includes("youtube.com/embed") || videoUrl.endsWith(".mp4")){
        canEmbed = true;
    }

    if(canEmbed){
        document.getElementById("videoFrame").src = videoUrl;
        document.getElementById("videoModal").style.display = "flex";
    } else {
        window.open(videoUrl, "_blank");
    }
}


function closeModal(){
    document.getElementById("videoFrame").src = "";
    document.getElementById("videoModal").style.display = "none";
}
</script>

</body>
</html>
