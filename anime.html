<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> الأنمي</title>
<style>
body { font-family: Arial, sans-serif; background:#121212; color:#fff; margin:0; padding:0; text-align:center; }
header { background:#ff3b3f; padding:20px; font-size:26px; font-weight:bold; }
button {
    margin:5px; padding:10px 15px; border-radius:5px;
    border:none; cursor:pointer; background:#ff3b3f; color:#fff;
    transition:0.3s;
}
button:hover { opacity:0.8; }

/* قائمة الحلقات على شكل شبكة */
#episodeList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    justify-items: center;
    margin:20px auto;
    max-width: 900px;
}

/* زر الحلقة */
#episodeList button {
    width: 100%;
    padding:10px;
    box-sizing: border-box;
}

/* نافذة الفيديو Modal */
.modal {
    display:none; position:fixed; z-index:1000;
    left:0; top:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
}
.modal-content {
    position:relative; background:#000; padding:10px; border-radius:10px;
    max-width:900px; width:90%;
}
.close-btn {
    position:absolute; top:5px; right:10px;
    background:#ff3b3f; border:none; color:#fff; font-size:18px;
    padding:5px 10px; cursor:pointer; border-radius:5px;
}
iframe { width:100%; height:500px; border:none; border-radius:10px; }

/* صورة الأنمي أكبر */
img.anime-img {
    width:95%;          
    max-width:600px;    
    border-radius:10px; 
    margin-top:20px; 
    box-shadow:0 0 20px #ff3b3f; 
}
.anime-categories {
    margin:10px 0;
    font-size:15px;
    color:#ffcc00;
}
</style>
</head>
<body>

<header>مشاهدة الأنمي</header>

<!-- زر الرجوع -->
<button onclick="goHome()">⬅ الرجوع للرئيسية</button>

<div id="animeContainer">
    <p>جارٍ تحميل الأنمي...</p>
</div>

<!-- نافذة الفيديو Modal -->
<div id="videoModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">✖</button>
        <iframe id="videoFrame" src="" allowfullscreen></iframe>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
function goHome(){ window.location.href="index.html"; }

function getAnimeTitle(){
    const params = new URLSearchParams(window.location.search);
    return params.get('title');
}

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBYEyu6TxSv1qSLCRvr0YCdaVcewhxAmQY",
  authDomain: "appp-1234.firebaseapp.com",
  databaseURL: "https://appp-1234-default-rtdb.firebaseio.com",
  projectId: "appp-1234",
  storageBucket: "appp-1234.firebasestorage.app",
  messagingSenderId: "666495369108",
  appId: "1:666495369108:web:aabf062e066cea6c3b9981",
  measurementId: "G-ENJMS8EWNT"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const animesRef = database.ref('animes');

let animes = [];

// جلب البيانات من Firebase
animesRef.on('value', snapshot => {
    const data = snapshot.val();
    if(data){
        animes = data;
        showAnime();
    }
});

function showAnime(){
    const title = getAnimeTitle();
    const anime = animes.find(a => a.title === title);
    const container = document.getElementById("animeContainer");

    if(!anime){
        container.innerHTML = "<p>❌ لم يتم العثور على هذا الأنمي</p>";
        return;
    }

    const categories = Array.isArray(anime.category) ? anime.category.join("، ") : anime.category;

    container.innerHTML = `
        <img src="${anime.image}" alt="${anime.title}" class="anime-img">
        <h2>${anime.title}</h2>
        <div class="anime-categories">التصنيفات: ${categories}</div>
        <h3>${anime.season}</h3>
        <div id="episodeList"></div>
        <p>اختر حلقة لتشغيل الفيديو</p>
    `;

    const episodeList = document.getElementById("episodeList");
    episodeList.innerHTML = "";

    anime.episodes.forEach(ep=>{
        const btn = document.createElement("button");
        btn.textContent = ep.title;
        btn.addEventListener("click", ()=> openModal(ep.video));
        episodeList.appendChild(btn);
    });
}

function openModal(videoUrl){
    let canEmbed = false;

    if(videoUrl.includes("youtube.com/watch")){
        const urlObj = new URL(videoUrl);
        const id = urlObj.searchParams.get("v");
        if(id){
            videoUrl = "https://www.youtube.com/embed/" + id;
            canEmbed = true;
        }
    }
    else if(videoUrl.includes("youtube.com/embed")){
        canEmbed = true;
    }
    else if(videoUrl.endsWith(".mp4")){
        canEmbed = true;
    }

    if(canEmbed){
        document.getElementById("videoFrame").src = videoUrl;
        document.getElementById("videoModal").style.display = "flex";
    } else {
        window.open(videoUrl, "_blank");
    }
}

function closeModal(){
    document.getElementById("videoFrame").src = "";
    document.getElementById("videoModal").style.display = "none";
}
</script>

</body>
</html>
